#!/bin/bash
(
	flock -xn 200 || exit

	# real max = 24242 = 2 * 17 * 23 * 31
	max=17

	get() {
		echo "$(cat /sys/class/backlight/*/brightness) / 2 / 23 / 31" | bc
	}
	change() {
		echo "$1 * 2 * 23 * 31" | bc > /sys/class/backlight/*/brightness
	}
	current=$(get)

	case $1 in
		+)
			current=$(($current + 1))
			;;
		
		-)
			current=$(($current - 1))
			;;

		*)
			if [[ "$1" != "" ]]; then
				current=$1
			fi
			;;
	esac
	(( $current > $max )) && current=$max
	(( $current < 0 )) && current=0
	change $current
	out="â˜€ [$(bar $max $current)]"
	echo "$out"
	id=/run/user/$(id -u)/$DISPLAY-backlight.notify-id
	[[ -f $id ]] || echo 0 > $id
	ag '^\d' $id > /dev/null || echo 0 > $id
	notify-send.sh -t 2000 -p -r "$(cat $id)" "$out" > $id
	if [[ $(get) != $current ]]; then
		echo $(get) $current
	fi
) 200>/run/user/$(id -u)/$DISPLAY-backlight.lock
